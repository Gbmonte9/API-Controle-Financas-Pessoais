html
  head
    title Perfil do Cliente
  body
    h1 Perfil do Cliente

    nav
      ul
        li: a(href="/perfil") Perfil
        li: a(href="/transacoes") Transações
        li: a(href="/transacoes/nova") Fazer Transações
        li: a(href="/relatorios") Relatórios
        li: a(href="/") Sair

    form
      div
        label(for="nome") Nome:
        input(type="text" id="nome" name="nome" required)

      div
        label(for="email") Email:
        input(type="email" id="email" name="email" required)

      div
        label(for="senha") Senha:
        input(type="password" id="senha" name="senha")

      div
        label(for="senha1") Confirmar Senha:
        input(type="password" id="senha1" name="senha1")

      div
        button(type="button" id="btmEditarCliente") Editar

      p#message(style="color: red;")

    script.
      (function () {
        document.addEventListener('DOMContentLoaded', function () {
          async function initPerfil() {
            const btnCadastrar = document.getElementById('btmEditarCliente');
            const message = document.getElementById('message');

            const token = localStorage.getItem('token');
            const emailToken = localStorage.getItem('email');

            if (!token || !emailToken) {
              alert('Você precisa estar logado.');
              window.location.href = '/';
              return;
            }

            try {
              const response = await fetch(`/cliente/dados/email/${emailToken}`, {
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              });

              const data = await response.json();

              if (!response.ok) {
                alert(data.erro || 'Erro ao buscar dados');
                return;
              }

              const cliente = Array.isArray(data) ? data[0] : data;

              document.getElementById('nome').value = cliente.nome;
              document.getElementById('email').value = cliente.email;
            } catch (err) {
              console.error(err);
              alert('Erro de conexão com o servidor');
            }

            btnCadastrar.addEventListener('click', async () => {
              const nome = document.getElementById('nome').value;
              const email = document.getElementById('email').value;
              const senha = document.getElementById('senha').value;
              const senha1 = document.getElementById('senha1').value;

              if (senha !== senha1) {
                message.textContent = 'As senhas não conferem';
                return;
              } else {
                message.textContent = '';
              }

              try {
                const response = await fetch('/cliente/perfil', {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify({ nome, email, senha })
                });

                const data = await response.json();

                if (!response.ok) {
                  alert(data.erro || 'Erro ao atualizar perfil');
                  return;
                }

                alert('Perfil atualizado com sucesso!');
                localStorage.setItem('email', email); 
              } catch (err) {
                console.error(err);
                alert('Erro de conexão com o servidor');
              }
            });
          }

          initPerfil(); 
        });
      })();